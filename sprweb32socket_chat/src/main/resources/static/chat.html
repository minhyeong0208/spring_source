<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>static/chat</title>
<link rel="stylesheet" href="/css/chat.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script type="text/javascript">
let stompClient = null;

function connect() {
	let socket = new SockJS('/ws');  // /ws ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ WebSocket ì—°ê²° ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
	
	// í´ë¼ì´ì–¸íŠ¸ê°€ WebSocket ì—°ê²°ì„ í†µí•´ Stompë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
	stompClient = Stomp.over(socket);
	
	// ì—°ê²°ì— ì„±ê³µí•˜ë©´ ì½œë°± í•¨ìˆ˜ê°€ í˜¸ì¶œë¨
	stompClient.connect({}, function(frame) {  // frame: command, header, bodyë¡œ êµ¬ì„±
		console.log('connected : ' + frame);
		// '/topic/messages' ë¡œ ìˆ˜ì‹ ëœ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬
		// ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ (êµ¬ë…)í•  í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ê°€ í•´ë‹¹ ê²½ë¡œì— ë¸Œë¡œë“œìºìŠ¤íŠ¸í•œ ë©”ì„¸ì§€ë¥¼ ëª¨ë‘ ìˆ˜ì‹  ê°€ëŠ¥í•˜ë‹¤.
		// íŠ¹ì • ì£¼ì œ('/topic/public')ë¥¼ êµ¬ë…í•˜ì—¬, ì„œë²„ì—ì„œ ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ 
		stompClient.subscribe('/topic/public', function(message) {
			showMessage(JSON.parse(message.body));  
		});
	});  
}

function sendMessage() {  // ë©”ì„¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” function
	let nameInput = document.querySelector("#name");
	let messageContent = document.querySelector("#message").value;
	
	// ì±„íŒ…ëª…(ì´ë¦„) ì…ë ¥ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš°, ì±„íŒ…ëª…ì„ ì…ë ¥ í›„ ì„œë²„ë¡œ ì „ì†¡ -> ì „ì†¡ì„ ë§ˆì¹œ í›„, ì´ë¦„ ì…ë ¥ë€ì„ ë¹„í™œì„±í™”
	if(!nameInput.disabled) {  // ì´ë¦„ ì…ë ¥ì´ ê°€ëŠ¥í•œ ê²½ìš°,
		stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender:nameInput.value, type:'JOIN'}));
		nameInput.disabled = true;
	}
	
	// ì…ë ¥ëœ ë©”ì„¸ì§€ê°€ ìˆê³ , ì—°ê²°ì´ ëœ ìƒíƒœë¼ë©´ ë©”ì„¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡
	if(messageContent && stompClient) {
		let chatMessage = {
			sender:nameInput.value,
			content:messageContent,
			type:'CHAT'
		};
		
		stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));  // ì±„íŒ… ì…ë ¥
		document.querySelector("#message").value = ''; // ì±„íŒ… ì…ë ¥ í›„, ì…ë ¥ê°’ ì‚­ì œ
	}
		
}

function showMessage(message) {
	let messageElement = document.createElement("li");
	
	// ë©”ì„¸ì§€ íƒ€ì…ì— ë”°ë¼ ì¶œë ¥ ë‚´ìš©ì´ ë‹¤ë¦„
	if(message.type === 'JOIN') {  // ì±„íŒ… ì…ì¥
		messageElement.classList.add('event-message');
		message.content = message.sender + "ë‹˜ ì…ì¥ ğŸ¶";
	} else if(message.type ==='LEAVE') {  // ì±„íŒ… í‡´ì¥
		messageElement.classList.add('event-message');
		message.content = message.sender + "ë‹˜ í‡´ì¥ â–";
	} else {  // ì±„íŒ…
		messageElement.classList.add('chat-message');
		// ì±„íŒ…ëª… : ë©”ì„¸ì§€ í˜•íƒœë¡œ ì¶œë ¥
		let userNameElement = document.createElement('strong');
		messageElement.classList.add('nickname');
		
		let usernameText = document.createTextNode(message.sender + ":");
		
		userNameElement.appendChild(usernameText);
		messageElement.appendChild(userNameElement);
		
		 // ìŠ¤í¬ë¡¤
	    let messageArea = document.querySelector("#messageArea");
	    messageArea.scrollTop = messageArea.scrollHeight;
	}
	
	// ë©”ì„¸ì§€ ë‚´ìš© í‘œì‹œ
	let textElement = document.createElement('span');
	let messageText = document.createTextNode(message.content);
	textElement.appendChild(messageText);  // <span>ì±„íŒ… ë‚´ìš©</span>
	
	messageElement.appendChild(textElement);  // <strong>ì±„íŒ…ëª…</strong> : <span>ì±„íŒ… ë‚´ìš©</span> í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
	
	document.querySelector('#messageArea').appendChild(messageElement);
}

function leaveChat() {  // ì±„íŒ…ë°© í‡´ì¥ ì²˜ë¦¬ë¥¼ ìœ„í•œ í•¨ìˆ˜
	if(stompClient) {
		stompClient.disconnect();  // sockJSê°€ connect()ì™€ disconnect()ë¥¼ ì œê³µ.
	}
	
	// í‡´ì¥ í›„, ì¬ì…ì¥ì„ ìœ„í•´ ì±„íŒ…ëª… ì…ë ¥ì°½ í™œì„±í™”
	document.querySelector('#name').disabled = false;
	alert('ì±„íŒ…ë°© íƒˆì¶œ');
}

window.onload = function() {
	connect();
}

window.onbeforeunload = function() {  // ë¸Œë¼ìš°ì €ê°€ ë‹«íˆê¸° ì „ì— WebSocket ì—°ê²° ì¢…ë£Œ
	if(stompClient) {
		stompClient.disconnect();
	}
}
</script>
</head>
<body>
	<div>
		<h2 style="color: #004d40">ğŸ¡ ì±„íŒ…</h2>
		<ul id="messageArea">
		</ul>

		<!-- ì…ë ¥ì°½ê³¼ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
		<div id="inputContainer">
			<input type="text" id="name" placeholder="ì´ë¦„ ì…ë ¥"> <input
				type="text" id="message" size="100" placeholder="ë©”ì„¸ì§€ ì…ë ¥"
				onkeydown="if (event.keyCode == 13) sendMessage()">
			<button onclick="sendMessage()">ì „ì†¡</button>
			<button onclick="leaveChat()">í‡´ì¥</button>
		</div>
	</div>
	
	<ul id="messageArea"></ul>
</body>
</html>